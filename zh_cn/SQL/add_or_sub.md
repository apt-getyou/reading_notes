# 数据库加减的使用技巧  
date : 2016.07.06  10:02

---------------------
1. 场景  
在电商程序开发中，经常要对商品的库存，用户的账户金额进行加减。而这些字段在电商系统内属于重中之重，所以对这些字段的修改需要慎重考虑。  

1. 常规解决方法  
按照常规思维，对数据库内的字段内容进行增减。需要先从数据库内取出对应字段的内容,进行加减后使用update语句进行内容更新。这个思路在字段更新频率低的情况下不容易出现问题。但是当操作量上来后，多个进程同时对相同字段更新，这个时候如何区分先后呢。  
比如说一个用户现有资金为100，该用户在前台下单消费50元，按照之前的思路，则应先取出现有资金100，然后减去50得到最终数50，然后通过  
```SQL
update 用户资金表 set 用户资金 = 50
```
更新数据库，此时数据没有问题。但如果同时后台管理员对该用户资金进行充值处理，他先去取到的用户资产也会是100,然后加上充值金额50,最终金额为150，然后使用
```SQL
update 用户资金表 set 用户资金 = 150
```
那么此时用户的资金到底是多少？50 还是 150 呢？很明显，都不是。正确的应该是100。  
这个问题就很大了,资金在电商系统中是核心，你搞得这么不确定，这系统还怎么上线。   

  对于这种情况，我们可以在SQL上想办法。

  1. SQL实现  
  直接使用   
  ```SQl
  update 用户资金表 set 用户资金 = 用户资金 + 50
  ```
  这样就可能解决以上问题，让更新和查询同时进行。  
  同样，扣款也可以这样实现，
  ```SQL
  update 用户资金表 set 用户资金 = 用户资金 - 50
  ```
  但这又有一个问题：用户的资金够减么？如果我的资金只有100，但我想买一个200的东西，这样在没有信用额度之类概念的情况下，显然是不可以实现的。那么是否需要在扣款钱查询用户资金呢，如果这样做则在高并发的情况下又会出现错误。所以我们可以在SQL上添加条件：
  ```SQL
  update 用户资金表 set 用户资金 = 用户资金 - 50 where (用户资金 - 50 ) > 0
  ```
  通过返回的影响数据库行数进行判断,如果行数为0，则说明条件不成立，更新失败，做对应的异常处理.  
  但这种方法只适合于逻辑简单的情况实现，如果系统内资金计算逻辑复杂，那么这么一条简单的SQL是无法实现的。

  1. 悲观锁  
  由于逻辑复杂，无法使用SQL直接实现的情况下，我们可以考虑使用数据库锁来实现加减。  
  悲观锁即在操作时将操作数据进行加锁处理，使其他人无法操作该行数据，这样保证数据的正确。但这种方式特别要注意对数据库锁的处理，处理不当则很容易发生死锁情况，导致系统不稳定。

  1. 乐观锁  
  在逻辑复杂的情况下，我们可以选择在数据库内加锁保证数据正确，也可以选择在程序内“加锁”。
  在设计数据库时，一般会为表添加 `update_time`字段，并让该字段在每次数据发生更改后实时更新，我们在编写代码时，就可以利用这个字段为程序加锁。
  以扣款为例
  首先，我们从数据库内获取到我们所需的用户资金数据，其中便有此时`update_time`的值 `time`。
  然后我们根据相应逻辑进行各种操作，最后得出用户资金的最终得数，然后就可以进行update操作了
  ```SQL
  update 用户资金表 set 用户资金 = 用户资金最终得数 where update_time = `time`
  ```
  此时如果程序返回 0 ，即程序更新失败，`update_time !=time` , 说明该数据已经被修改了，需要重新计算。
  
  ### 结论  
  在逻辑相对简单的情况下直接推荐使用SQL实现，但在逻辑复杂，无法在一条SQL内实现，可使用乐观锁，但乐观锁容易出现失败情况，在实际操作上应对高并发，可以实现数据无异常，但直接失败的体验对于用户来说十分的不友好，所以在使用上不能简单的进行失败处理，需要增加容错率以增强用户体验。悲观锁实现简单，但如果在编程时不够注意的话，容易产生死锁，所以在编程时需格外注意，但写好了可以保证数据的稳定，并且有良好的用户体验。所以具体使用哪种方式还是需要结合实际业务和个人水平来选择（笑）。
