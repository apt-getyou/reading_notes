# 数据库加减的使用技巧  
date : 2016.07.06  10:02

---------------------

在电商程序开发中，经常要对商品的库存，用户的账户金额进行加减。而这些字段在电商系统内属于重中之重，所以对这些字段的修改需要慎重考虑。  
按照常规思维，对数据库内的字段内容进行增减。需要先从数据库内取出对应字段的内容,进行加减后使用update语句进行内容更新。这个思路在字段更新频率低的情况下不容易出现问题。但是当操作量上来后，多个进程同时对相同字段更新，这个时候如何区分先后呢。  
比如说一个用户现有资金为100，该用户在前台下单消费50元，按照之前的思路，则应先取出现有资金100，然后减去50得到最终数50，然后通过`update 用户资金表 set 用户资金 = 50 `更新数据库，此时数据没有问题。但如果同时后台管理员对该用户资金进行充值处理，他先去取到的用户资产也会是100,然后加上充值金额50,最终金额为150，然后使用`update 用户资金表 set 用户资金 = 150`，那么此时用户的资金到底是多少？50 还是 150 呢？很明显，都不是。正确的应该是100。这个问题就很大了。。资金在电商系统中是核心，你搞得这么不确定，这系统还怎么上线。  
那么给数据库加锁行不行，一次只允许一个进程进行操作，这样虽然能解决数据不正确的问题，但是很容易导致出现死锁现象，强烈不推荐。  
对于这种情况，我们可以在SQL上想办法。
直接使用 `update 用户资金表 set 用户资金 = 用户资金 + 50`，这样就可能解决以上问题，让更新和查询同时进行。  
同样，扣款也可以这样实现，`update 用户资金表 set 用户资金 = 用户资金 - 50`，但这又有一个问题：用户的资金够减么？如果我的资金只有100，但我想买一个200的东西，这样在没有信用额度之类概念的情况下，显然是不可以实现的。那么是否需要在扣款钱查询用户资金呢，如果这样做则在高并发的情况下又会出现错误。所以我们可以在SQL上添加条件：`update 用户资金表 set 用户资金 = 用户资金 - 50 where (用户资金 - 50 ) > 0`。  
然而更新在程序里并不会报错，你如何判断是否更新成功呢？可以通过返回的影响数据库行数进行判断。如果行数为0，则说明条件不成立，更新失败，做对应的异常处理
